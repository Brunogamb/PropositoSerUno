---
---
<main>
    <div id="login-form">
        <h1>Iniciar sesión</h1>
        <h2>Accede a tu cuenta ingresando tu dirección de correo electrónico y tu código de acceso.</h2>
        <form novalidate>
            <input type="email" id="email" placeholder="Correo electrónico" />
            <span class="field-error" id="email-error"></span>

            <div class="password-wrapper">
                <input type="password" id="code" placeholder="Código" minlength="4" />
                <span class="field-error" id="code-error"></span>
                <p id="login-error">Código o email incorrecto</p>
                <label class="show-code">
                    <input type="checkbox" id="show-code-checkbox" />
                    <span>Mostrar código</span>
                </label>
            </div>

            <button id="login-btn" type="button">Iniciar sesión</button>
        </form>
    </div>
</main>

<style>
main {
    display: flex;
    justify-content: center;
    align-items: center;
}

h1 {
    font-family: 'Playfair Display', serif;
    font-weight: 500;
    text-align: center;
    margin-bottom: 10px;
    color: #2c0db3;
    letter-spacing: -0.5px;
}

h2 {
    width: 400px;
    text-align: center;
    margin-bottom: 30px;
    color: #444;
    font-weight: 400;
    font-size: 18px;
    text-wrap: balance;
}

form {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#login-form {
    margin: auto;
    background: #fff;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

#login-form input:not([type="checkbox"]) {
    display: flex;
    margin-bottom: 10px;
    padding: 8px;
    width: 200px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.password-wrapper {
    display: flex;
    align-items: center;
    flex-direction: column;
    gap: 8px;
}

.show-code {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #444;
    margin-bottom: 20px;
}

.show-code input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.field-error {
    display: none;
    color: #ff1111;
    font-size: 14px;
    margin-top: -6px;
    margin-bottom: 8px;
}

#login-form button {
    display: block;
    margin: auto;
    padding: 8px 16px;
    background-color: #2c0db3;
    color: #f1f1f1;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#login-form button:hover {
    background-color: #1a0a8a;
}

#login-error {
    display: none;
    color: #ff1111;
}
</style>

<script type="module">
import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

const SUPABASE_URL = 'https://jfejymhssyiypzlbogcq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmZWp5bWhzc3lpeXB6bGJvZ2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTkzMTUsImV4cCI6MjA3Mjc3NTMxNX0.mOR_IEKzwJ-KrnEGG0bMgxNwF2QDgq5c1jas-LcHkfQ';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
        persistSession: false
    }
});

const loginBtn = document.getElementById("login-btn");
const errorMsg = document.getElementById("login-error");
const emailInput = document.getElementById("email");
const codeInput = document.getElementById("code");
const showCodeCheckbox = document.getElementById("show-code-checkbox");
const emailError = document.getElementById("email-error");
const codeError = document.getElementById("code-error");

function clearFieldErrors() {
    emailError.style.display = "none";
    emailError.textContent = "";
    codeError.style.display = "none";
    codeError.textContent = "";
    errorMsg.style.display = "none";
}

function showFieldError(el, msg) {
    el.textContent = msg;
    el.style.display = "block";
}

if (showCodeCheckbox) {
    showCodeCheckbox.addEventListener('change', () => {
        codeInput.type = showCodeCheckbox.checked ? 'text' : 'password';
    });
}

loginBtn.addEventListener("click", async () => {
    clearFieldErrors();

    const email = emailInput.value.trim();
    const code = codeInput.value.trim();

    let hasError = false;

    if (!email) {
        showFieldError(emailError, "El correo electrónico es obligatorio");
        hasError = true;
    } else if (!email.includes('@') || !/\S+@\S+\.\S+/.test(email)) {
        if (!email.includes('@')) {
            showFieldError(emailError, "El correo debe contener '@'");
        } else {
            showFieldError(emailError, "Ingresa un correo electrónico válido");
        }
        hasError = true;
    }

    if (!code) {
        showFieldError(codeError, "El código es obligatorio");
        hasError = true;
    }

    const minLen = 4;
    if (code && code.length < minLen) {
        showFieldError(codeError, `El código debe tener al menos ${minLen} caracteres`);
        hasError = true;
    }

    if (hasError) return;

    try {
        loginBtn.textContent = "Iniciando sesión...";
        loginBtn.disabled = true;

        const { data, error } = await supabase
            .from('users')
            .select('id, email')
            .eq('email', email)
            .eq('code', code);

        if (error) {
            if (error.code === '42501') {
                errorMsg.textContent = "Error de permisos. La tabla no es accesible";
                errorMsg.style.display = "block";
            } else {
                errorMsg.textContent = "Error de conexión. Inténtalo de nuevo";
                errorMsg.style.display = "block";
            }
            return;
        }

        if (data && data.length > 0) {
            document.cookie = "loggedIn=true; path=/; max-age=86400"; // 24 horas
            document.cookie = `userId=${data[0].id}; path=/; max-age=86400`;
            
            localStorage.setItem("loggedIn", "true");
            localStorage.setItem("userId", data[0].id);
            
            window.location.href = "/PropositoSerUno/";
        } else {
            errorMsg.style.display = "block";
        }
    } catch (err) {
        errorMsg.textContent = "Error inesperado. Verifica tu conexión a internet";
        errorMsg.style.display = "block";
    } finally {

        loginBtn.textContent = "Iniciar sesión";
        loginBtn.disabled = false;
    }
});
</script>